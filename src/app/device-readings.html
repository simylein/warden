<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="itf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="View readings from your device" />
		<title>Warden device readings</title>
		<style></style>
	</head>
	<body class="font-sans m-0 text-black dark:text-white background-white dark:background-black" onload="loadReadings()">
		<header class="sticky top-0 w-full background-neutral-100 dark:background-neutral-900 z-4">
			<nav
				class="flex flex-row gap-2 sm:gap-3 lg:gap-4 pt-2 sm:pt-3 lg:pt-4 pr-4 sm:pr-8 lg:pr-16 pb-2 sm:pb-3 lg:pb-4 pl-4 sm:pl-8 lg:pl-16 text-lg font-normal overflow-x-auto scrollbar-none"
			>
				<a href="/" class="no-underline text-black dark:text-white">Home</a>
				<a href="/devices" class="no-underline text-black dark:text-white">Devices</a>
				<a href="/uplinks" class="no-underline text-black dark:text-white">Uplinks</a>
			</nav>
		</header>
		<main class="m-4 sm:m-8 lg:m-16">
			<div
				id="tabs"
				class="flex gap-2 sm:gap-3 lg:gap-4 m-0 mb-2 sm:mb-4 lg:mb-8 pt-2 sm:pt-3 lg:pt-4 pb-2 sm:pb-3 lg:pb-4 text-base font-normal border-0 border-b-1 border-solid border-b-neutral-400 dark:border-b-neutral-600"
			>
				<a class="text-base font-normal no-underline text-black dark:text-white">Details</a>
				<a class="text-base font-normal no-underline text-blue-600 dark:text-blue-400">Readings</a>
				<a class="text-base font-normal no-underline text-black dark:text-white">Metrics</a>
			</div>
			<div class="flex flex-col gap-2 sm:gap-4 lg:gap-8">
				<div id="ranges" class="flex gap-2 sm:gap-3 md:gap-4 overflow-x-auto scrollbar-none text-nowrap">
					<button
						value="604800"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(604800); setRange(604800); loadReadings()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">7d</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">7 days</p>
					</button>
					<button
						value="345600"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(345600); setRange(345600); loadReadings()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">4d</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">4 days</p>
					</button>
					<button
						value="172800"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(172800); setRange(172800); loadReadings()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">2d</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">2 days</p>
					</button>
					<button
						value="86400"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(86400); setRange(86400); loadReadings()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">24h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">24 hours</p>
					</button>
					<button
						value="43200"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(43200); setRange(43200); loadReadings()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">12h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">12 hours</p>
					</button>
					<button
						value="21600"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(21600); setRange(21600); loadReadings()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">6h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">6 hours</p>
					</button>
					<button
						value="10800"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(10800); setRange(10800); loadReadings()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">3h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">3 hours</p>
					</button>
				</div>
				<div class="p-2 sm:p-3 lg:p-4 background-neutral-100 dark:background-neutral-900">
					<div class="flex justify-between gap-2 mb-1 sm:mb-2 lg:mb-1 xl:mb-2">
						<h2 class="m-0 text-base font-normal">Temperature</h2>
						<p id="temperature-range" class="m-0 w-28 h-4.5 background-neutral-200 dark:background-neutral-800"><span></span><span></span><span></span></p>
					</div>
					<div style="grid-template-columns: auto 1fr; grid-template-rows: auto auto" class="grid gap-1 sm:gap-2 lg:gap-1 xl:gap-2">
						<div id="temperature-scale" class="flex flex-col text-xs text-end">
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
						<div class="relative flex flex-col">
							<svg id="temperature-graph" class="absolute w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
								<path
									class="stroke-neutral-200 dark:stroke-neutral-800"
									fill="none"
									stroke-width="2"
									d="M 0 53 L 1 63 L 2 70 L 3 60 L 4 64 L 5 68 L 6 59 L 7 61 L 8 65 L 9 50 L 10 46 L 11 49 L 12 31 L 13 35 L 14 45 L 15 38 L 16 56 L 17 72 L 18 69 L 19 66 L 20 64 L 21 52 L 22 57 L 23 74 L 24 62 L 25 65 L 26 69 L 27 58 L 28 62 L 29 68 L 30 86 L 31 81 L 32 72 L 33 66 L 34 65 L 35 47 L 36 44 L 37 54 L 38 65 L 39 80 L 40 63 L 41 61 L 42 78 L 43 88 L 44 84 L 45 71 L 46 66 L 47 63 L 48 50 L 49 47 L 50 59 L 51 55 L 52 50 L 53 67 L 54 69 L 55 64 L 56 62 L 57 60 L 58 48 L 59 42 L 60 40 L 61 43 L 62 39 L 63 36 L 64 46 L 65 45 L 66 35 L 67 33 L 68 46 L 69 59 L 70 48 L 71 61 L 72 70 L 73 86 L 74 77 L 75 79 L 76 80 L 77 69 L 78 56 L 79 60 L 80 45 L 81 50 L 82 64 L 83 59 L 84 66 L 85 82 L 86 90 L 87 95 L 88 91 L 89 88 L 90 85 L 91 69 L 92 56 L 93 67 L 94 72 L 95 89 L 96 93 L 97 91 L 98 76 L 99 79 L 100 60"
								/>
								<path class="stroke-fuchsia-400/80 dark:stroke-fuchsia-600/80" fill="none" stroke-width="2" />
								<path class="stroke-purple-400/80 dark:stroke-purple-600/80" fill="none" stroke-width="2" />
								<path class="stroke-violet-400/80 dark:stroke-violet-600/80" fill="none" stroke-width="2" />
								<path class="stroke-indigo-400/80 dark:stroke-indigo-600/80" fill="none" stroke-width="2" />
								<path class="stroke-blue-400/80 dark:stroke-blue-600/80" fill="none" stroke-width="2" />
								<path class="stroke-sky-400/80 dark:stroke-sky-600/80" fill="none" stroke-width="2" />
								<path class="stroke-cyan-400/80 dark:stroke-cyan-600/80" fill="none" stroke-width="2" />
								<path class="stroke-teal-400/80 dark:stroke-teal-600/80" fill="none" stroke-width="2" />
								<path class="stroke-emerald-400/80 dark:stroke-emerald-600/80" fill="none" stroke-width="2" />
								<path class="stroke-green-400/80 dark:stroke-green-600/80" fill="none" stroke-width="2" />
								<path class="stroke-lime-400/80 dark:stroke-lime-600/80" fill="none" stroke-width="2" />
								<path class="stroke-yellow-400/80 dark:stroke-yellow-600/80" fill="none" stroke-width="2" />
								<path class="stroke-amber-400/80 dark:stroke-amber-600/80" fill="none" stroke-width="2" />
								<path class="stroke-orange-400/80 dark:stroke-orange-600/80" fill="none" stroke-width="2" />
								<path class="stroke-red-400/80 dark:stroke-red-600/80" fill="none" stroke-width="2" />
								<path class="stroke-rose-400/80 dark:stroke-rose-600/80" fill="none" stroke-width="2" />
							</svg>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
						</div>
						<div></div>
						<div id="temperature-label" class="w-full flex justify-around text-xs">
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
					</div>
				</div>
				<div class="p-2 sm:p-3 lg:p-4 background-neutral-100 dark:background-neutral-900">
					<div class="flex justify-between gap-2 mb-1 sm:mb-2 lg:mb-1 xl:mb-2">
						<h2 class="m-0 text-base font-normal">Humidity</h2>
						<p id="humidity-range" class="m-0 w-28 h-4.5 background-neutral-200 dark:background-neutral-800"><span></span><span></span><span></span></p>
					</div>
					<div style="grid-template-columns: auto 1fr; grid-template-rows: auto auto" class="grid gap-1 sm:gap-2 lg:gap-1 xl:gap-2">
						<div id="humidity-scale" class="flex flex-col text-xs text-end">
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
						<div class="relative flex flex-col">
							<svg id="humidity-graph" class="absolute w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
								<path
									class="stroke-neutral-200 dark:stroke-neutral-800"
									fill="none"
									stroke-width="2"
									d="M 0 31 L 1 36 L 2 38 L 3 41 L 4 55 L 5 49 L 6 54 L 7 37 L 8 32 L 9 43 L 10 50 L 11 45 L 12 41 L 13 35 L 14 33 L 15 24 L 16 42 L 17 44 L 18 48 L 19 30 L 20 33 L 21 21 L 22 34 L 23 44 L 24 50 L 25 42 L 26 36 L 27 41 L 28 47 L 29 30 L 30 19 L 31 24 L 32 31 L 33 48 L 34 51 L 35 46 L 36 30 L 37 18 L 38 37 L 39 33 L 40 26 L 41 40 L 42 35 L 43 19 L 44 21 L 45 11 L 46 15 L 47 17 L 48 36 L 49 28 L 50 31 L 51 43 L 52 51 L 53 60 L 54 69 L 55 58 L 56 73 L 57 59 L 58 50 L 59 62 L 60 71 L 61 90 L 62 77 L 63 85 L 64 69 L 65 57 L 66 39 L 67 41 L 68 54 L 69 49 L 70 46 L 71 33 L 72 24 L 73 43 L 74 37 L 75 42 L 76 59 L 77 67 L 78 62 L 79 45 L 80 42 L 81 24 L 82 20 L 83 38 L 84 46 L 85 34 L 86 27 L 87 13 L 88 21 L 89 31 L 90 45 L 91 37 L 92 50 L 93 56 L 94 71 L 95 60 L 96 66 L 97 70 L 98 84 L 99 97 L 100 89"
								/>
								<path class="stroke-red-400/80 dark:stroke-red-600/80" fill="none" stroke-width="2" />
								<path class="stroke-orange-400/80 dark:stroke-orange-600/80" fill="none" stroke-width="2" />
								<path class="stroke-amber-400/80 dark:stroke-amber-600/80" fill="none" stroke-width="2" />
								<path class="stroke-yellow-400/80 dark:stroke-yellow-600/80" fill="none" stroke-width="2" />
								<path class="stroke-lime-400/80 dark:stroke-lime-600/80" fill="none" stroke-width="2" />
								<path class="stroke-green-400/80 dark:stroke-green-600/80" fill="none" stroke-width="2" />
								<path class="stroke-emerald-400/80 dark:stroke-emerald-600/80" fill="none" stroke-width="2" />
								<path class="stroke-teal-400/80 dark:stroke-teal-600/80" fill="none" stroke-width="2" />
								<path class="stroke-cyan-400/80 dark:stroke-cyan-600/80" fill="none" stroke-width="2" />
								<path class="stroke-sky-400/80 dark:stroke-sky-600/80" fill="none" stroke-width="2" />
								<path class="stroke-blue-400/80 dark:stroke-blue-600/80" fill="none" stroke-width="2" />
								<path class="stroke-indigo-400/80 dark:stroke-indigo-600/80" fill="none" stroke-width="2" />
							</svg>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
						</div>
						<div></div>
						<div id="humidity-label" class="w-full flex justify-around text-xs">
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
					</div>
				</div>
			</div>
		</main>
	</body>
	<script>
		// @inject ./src/app/array.js
		// @inject ./src/app/state.js
		// @inject ./src/app/color-reading.js
		// @inject ./src/app/fetcher.js
		// @inject ./src/app/binary.js
		const tabs = document.getElementById('tabs');
		tabs.children[0].href = `${window.location.pathname.substring(0, 40)}`;
		tabs.children[1].href = `${window.location.pathname.substring(0, 40)}/readings`;
		tabs.children[2].href = `${window.location.pathname.substring(0, 40)}/metrics`;
		const ranges = document.getElementById('ranges');
		const readings = { retries: 0, timeout: null, controller: null, data: null };
		const temperature = {
			range: document.getElementById('temperature-range'),
			scale: document.getElementById('temperature-scale'),
			graph: document.getElementById('temperature-graph'),
			label: document.getElementById('temperature-label'),
		};
		const humidity = {
			range: document.getElementById('humidity-range'),
			scale: document.getElementById('humidity-scale'),
			graph: document.getElementById('humidity-graph'),
			label: document.getElementById('humidity-label'),
		};
		const temperatureSkeleton =
			'M 0 53 L 1 63 L 2 70 L 3 60 L 4 64 L 5 68 L 6 59 L 7 61 L 8 65 L 9 50 L 10 46 L 11 49 L 12 31 L 13 35 L 14 45 L 15 38 L 16 56 L 17 72 L 18 69 L 19 66 L 20 64 L 21 52 L 22 57 L 23 74 L 24 62 L 25 65 L 26 69 L 27 58 L 28 62 L 29 68 L 30 86 L 31 81 L 32 72 L 33 66 L 34 65 L 35 47 L 36 44 L 37 54 L 38 65 L 39 80 L 40 63 L 41 61 L 42 78 L 43 88 L 44 84 L 45 71 L 46 66 L 47 63 L 48 50 L 49 47 L 50 59 L 51 55 L 52 50 L 53 67 L 54 69 L 55 64 L 56 62 L 57 60 L 58 48 L 59 42 L 60 40 L 61 43 L 62 39 L 63 36 L 64 46 L 65 45 L 66 35 L 67 33 L 68 46 L 69 59 L 70 48 L 71 61 L 72 70 L 73 86 L 74 77 L 75 79 L 76 80 L 77 69 L 78 56 L 79 60 L 80 45 L 81 50 L 82 64 L 83 59 L 84 66 L 85 82 L 86 90 L 87 95 L 88 91 L 89 88 L 90 85 L 91 69 L 92 56 L 93 67 L 94 72 L 95 89 L 96 93 L 97 91 L 98 76 L 99 79 L 100 60';
		const humiditySkeleton =
			'M 0 31 L 1 36 L 2 38 L 3 41 L 4 55 L 5 49 L 6 54 L 7 37 L 8 32 L 9 43 L 10 50 L 11 45 L 12 41 L 13 35 L 14 33 L 15 24 L 16 42 L 17 44 L 18 48 L 19 30 L 20 33 L 21 21 L 22 34 L 23 44 L 24 50 L 25 42 L 26 36 L 27 41 L 28 47 L 29 30 L 30 19 L 31 24 L 32 31 L 33 48 L 34 51 L 35 46 L 36 30 L 37 18 L 38 37 L 39 33 L 40 26 L 41 40 L 42 35 L 43 19 L 44 21 L 45 11 L 46 15 L 47 17 L 48 36 L 49 28 L 50 31 L 51 43 L 52 51 L 53 60 L 54 69 L 55 58 L 56 73 L 57 59 L 58 50 L 59 62 L 60 71 L 61 90 L 62 77 L 63 85 L 64 69 L 65 57 L 66 39 L 67 41 L 68 54 L 69 49 L 70 46 L 71 33 L 72 24 L 73 43 L 74 37 L 75 42 L 76 59 L 77 67 L 78 62 L 79 45 L 80 42 L 81 24 L 82 20 L 83 38 L 84 46 L 85 34 L 86 27 L 87 13 L 88 21 L 89 31 L 90 45 L 91 37 L 92 50 L 93 56 L 94 71 L 95 60 L 96 66 L 97 70 L 98 84 L 99 97 L 100 89';
		const getRange = () => {
			const range = new URLSearchParams(window.location.search).get('range');
			return +(range ?? 86400);
		};
		const setRange = (range) => {
			const params = new URLSearchParams(window.location.search);
			params.set('range', range);
			window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
		};
		const highlightRange = (range) => {
			array(ranges.children.length).forEach((ind) => {
				if (+ranges.children[ind].getAttribute('value') === range) {
					array(ranges.children[ind].children.length).forEach((i) => {
						ranges.children[ind].children[i].classList.add('text-blue-600', 'dark:text-blue-400');
						ranges.children[ind].children[i].classList.remove('text-black', 'dark:text-white');
					});
				} else {
					array(ranges.children[ind].children.length).forEach((i) => {
						ranges.children[ind].children[i].classList.remove('text-blue-600', 'dark:text-blue-400');
						ranges.children[ind].children[i].classList.add('text-black', 'dark:text-white');
					});
				}
			});
		};
		highlightRange(getRange());
		const loadingTemperature = (element) => {
			array(element.label.children.length).forEach((ind) => {
				loading(element.label.children[ind], ['w-8'], [], '');
			});
			loading(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				loading(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				loading(element.scale.children[ind], [], [], '');
			});
			array(element.graph.children.length).forEach((ind) => {
				if (ind === 0) {
					element.graph.children[ind].classList.add('stroke-neutral-200', 'dark:stroke-neutral-800');
					element.graph.children[0].classList.remove('stroke-red-200', 'dark:stroke-red-800');
					element.graph.children[ind].setAttribute('d', temperatureSkeleton);
				} else {
					element.graph.children[ind].removeAttribute('d');
				}
			});
		};
		const paintTemperature = (element, temperature, capturedAt) => {
			const interval = (Number(capturedAt.end) - Number(capturedAt.start)) / element.label.children.length - 1;
			array(element.label.children.length).forEach((ind) => {
				const date = new Date((Number(capturedAt.start) + ind * interval) * 1000);
				const hours = date.getHours().toString().padStart(2, '0');
				const minutes = date.getMinutes().toString().padStart(2, '0');
				paint(element.label.children[element.label.children.length - ind - 1], [], ['w-8'], `${hours}:${minutes}`);
			});
			if (temperature.min.abs !== null && temperature.max.abs !== null) {
				paint(element.range, [], ['w-28', 'h-4.5']);
				paint(element.range.children[0], [], [], temperature.min.abs.toFixed(2));
				colorTemperature(element.range.children[0], temperature.min.abs);
				paint(element.range.children[1], [], [], ' - ');
				paint(element.range.children[2], [], [], temperature.max.abs.toFixed(2));
				colorTemperature(element.range.children[2], temperature.max.abs);
			}
			if (temperature.min.floor !== null && temperature.max.ceil !== null) {
				const scaleLength = element.scale.children.length;
				const interval = (temperature.max.ceil - temperature.min.floor) / scaleLength;
				array(scaleLength).forEach((ind) => {
					paint(element.scale.children[scaleLength - 1 - ind], [], [], (temperature.min.floor + ind * interval).toFixed(1));
				});
			}
			element.graph.children[0].removeAttribute('d');
			const distance = 100 / temperature.points.reduce((accumulator, points) => accumulator + points.length, 0);
			array(element.graph.children.length).forEach((ind) => {
				const d = temperature.points[ind].map((point, i) => {
					let type = i === 0 ? 'M' : 'L';
					const last = i === 0 ? point : temperature.points[ind][i - 1];
					if (last.x - point.x > distance * 2) {
						type = 'M';
					}
					return `${type} ${point.x.toFixed(1)} ${point.y.toFixed(1)}`;
				});
				if (d.length !== 0) {
					element.graph.children[ind].setAttribute('d', d.join(' '));
				}
			});
		};
		const errorTemperature = (element) => {
			array(element.label.children.length).forEach((ind) => {
				error(element.label.children[ind], ['w-8'], [], '');
			});
			error(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				error(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				error(element.scale.children[ind], [], [], '');
			});
			element.graph.children[0].classList.add('stroke-red-200', 'dark:stroke-red-800');
			element.graph.children[0].classList.remove('stroke-neutral-200', 'dark:stroke-neutral-800');
		};
		const loadingHumidity = (element) => {
			array(element.label.children.length).forEach((ind) => {
				loading(element.label.children[ind], ['w-8'], [], '');
			});
			loading(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				loading(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				loading(element.scale.children[ind], [], [], '');
			});
			array(element.graph.children.length).forEach((ind) => {
				if (ind === 0) {
					element.graph.children[ind].classList.add('stroke-neutral-200', 'dark:stroke-neutral-800');
					element.graph.children[0].classList.remove('stroke-red-200', 'dark:stroke-red-800');
					element.graph.children[ind].setAttribute('d', humiditySkeleton);
				} else {
					element.graph.children[ind].removeAttribute('d');
				}
			});
		};
		const paintHumidity = (element, humidity, capturedAt) => {
			const interval = (Number(capturedAt.end) - Number(capturedAt.start)) / element.label.children.length - 1;
			array(element.label.children.length).forEach((ind) => {
				const date = new Date((Number(capturedAt.start) + ind * interval) * 1000);
				const hours = date.getHours().toString().padStart(2, '0');
				const minutes = date.getMinutes().toString().padStart(2, '0');
				paint(element.label.children[element.label.children.length - ind - 1], [], ['w-8'], `${hours}:${minutes}`);
			});
			if (humidity.min.abs !== null && humidity.max.abs !== null) {
				paint(element.range, [], ['w-28', 'h-4.5']);
				paint(element.range.children[0], [], [], humidity.min.abs.toFixed(2));
				colorHumidity(element.range.children[0], humidity.min.abs);
				paint(element.range.children[1], [], [], ' - ');
				paint(element.range.children[2], [], [], humidity.max.abs.toFixed(2));
				colorHumidity(element.range.children[2], humidity.max.abs);
			}
			if (humidity.min.floor !== null && humidity.max.ceil !== null) {
				const scaleLength = element.scale.children.length;
				const interval = (humidity.max.ceil - humidity.min.floor) / scaleLength;
				array(scaleLength).forEach((ind) => {
					paint(element.scale.children[scaleLength - 1 - ind], [], [], (humidity.min.floor + ind * interval).toFixed(1));
				});
			}
			element.graph.children[0].removeAttribute('d');
			const distance = 100 / humidity.points.reduce((accumulator, points) => accumulator + points.length, 0);
			array(element.graph.children.length).forEach((ind) => {
				const d = humidity.points[ind].map((point, i) => {
					let type = i === 0 ? 'M' : 'L';
					const last = i === 0 ? point : humidity.points[ind][i - 1];
					if (last.x - point.x > distance * 2) {
						type = 'M';
					}
					return `${type} ${point.x.toFixed(1)} ${point.y.toFixed(1)}`;
				});
				if (d.length !== 0) {
					element.graph.children[ind].setAttribute('d', d.join(' '));
				}
			});
		};
		const errorHumidity = (element) => {
			array(element.label.children.length).forEach((ind) => {
				error(element.label.children[ind], ['w-8'], [], '');
			});
			error(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				loading(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				error(element.scale.children[ind], [], [], '');
			});
			element.graph.children[0].classList.add('stroke-red-200', 'dark:stroke-red-800');
			element.graph.children[0].classList.remove('stroke-neutral-200', 'dark:stroke-neutral-800');
		};
		const summarizeReadings = (readings, reading, type) => {
			const target = readings[type];
			if (target.min.abs === null || reading[type] < target.min.abs) {
				target.min.abs = reading[type];
				target.min.floor = Math.floor(reading[type]);
			}
			if (target.max.abs === null || reading[type] > target.max.abs) {
				target.max.abs = reading[type];
				target.max.ceil = Math.ceil(reading[type]);
			}
		};
		const coordinateReadings = (readings, reading, type) => {
			const target = readings[type];
			const xRange = Number(readings.capturedAt.end) - Number(readings.capturedAt.start);
			const xPercent = 100 - ((Number(reading.capturedAt) - Number(readings.capturedAt.start)) / xRange) * 100;
			const yRange = target.max.ceil - target.min.floor;
			const yPercent = 100 - ((reading[type] - target.min.floor) / yRange) * 100;
			let index = null;
			switch (type) {
				case 'temperature':
					index = Math.floor(reading[type] / 4) + 7;
					switch (true) {
						case index < 1:
							index = 1;
							break;
						case index > 16:
							index = 16;
							break;
					}
					target.points[index].push({ x: xPercent, y: yPercent });
					break;
				case 'humidity':
					index = Math.floor(reading[type] / 5) - 3;
					switch (true) {
						case index < 1:
							index = 1;
							break;
						case index < 3:
							index = 2;
							break;
						case index > 12:
							index = 12;
							break;
						case index > 10:
							index = 11;
							break;
					}
					target.points[index].push({ x: xPercent, y: yPercent });
					break;
			}
		};
		const calculateReadings = (data) => {
			const readings = {
				temperature: { min: { abs: null, floor: null }, max: { abs: null, ceil: null }, points: array(temperature.graph.children.length).map(() => []) },
				humidity: { min: { abs: null, floor: null }, max: { abs: null, ceil: null }, points: array(humidity.graph.children.length).map(() => []) },
				capturedAt: { start: null, end: null },
			};
			readings.capturedAt.start = Math.floor(Date.now() / 1000);
			readings.capturedAt.end = Math.floor(Date.now() / 1000 - getRange());
			data.forEach((reading) => {
				summarizeReadings(readings, reading, 'temperature');
				summarizeReadings(readings, reading, 'humidity');
			});
			data.forEach((reading) => {
				coordinateReadings(readings, reading, 'temperature');
				coordinateReadings(readings, reading, 'humidity');
			});
			return readings;
		};
		const parseReadings = async (response) => {
			const buffer = await response.arrayBuffer();
			const binary = new Binary(buffer);
			const readings = [];
			while (binary.offset < buffer.byteLength) {
				const reading = { temperature: null, humidity: null, capturedAt: null };
				reading.temperature = binary.int(16) / 100;
				reading.humidity = binary.uint(16) / 100;
				reading.capturedAt = binary.uint(64);
				readings.push(reading);
			}
			return readings;
		};
		const loadReadings = async () => {
			if (readings.timeout) {
				clearTimeout(readings.timeout);
				readings.timeout = null;
			}
			if (readings.controller) {
				readings.controller.abort();
			}
			readings.controller = new AbortController();
			window.requestAnimationFrame(() => loadingTemperature(temperature));
			window.requestAnimationFrame(() => loadingHumidity(humidity));
			try {
				const from = Math.floor(Date.now() / 1000) - getRange();
				const to = Math.floor(Date.now() / 1000);
				const endpoint = `/api/device/${window.location.pathname.substring(8)}?from=${from}&to=${to}`;
				const response = await fetcher('get', endpoint, null, { controller: readings.controller });
				readings.data = await parseReadings(response);
				const summary = calculateReadings(readings.data);
				window.requestAnimationFrame(() => paintTemperature(temperature, summary.temperature, summary.capturedAt));
				window.requestAnimationFrame(() => paintHumidity(humidity, summary.humidity, summary.capturedAt));
				highlightRange(getRange());
			} catch (err) {
				if (err?.name !== 'AbortError') {
					window.requestAnimationFrame(() => errorTemperature(temperature));
					window.requestAnimationFrame(() => errorHumidity(humidity));
					if (readings.retries < 4) {
						readings.timeout = setTimeout(() => {
							readings.retries++;
							loadReadings();
						}, 2 ** readings.retries * 1000);
					}
				}
			}
		};
	</script>
</html>
