<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="itf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="View signals from your device" />
		<title>Warden device signals</title>
		<style></style>
	</head>
	<body class="font-sans m-0 text-black dark:text-white background-white dark:background-black" onload="loadSignals()">
		<header class="sticky top-0 w-full background-neutral-100 dark:background-neutral-900 z-4">
			<nav
				class="flex flex-row gap-2 sm:gap-3 lg:gap-4 pt-2 sm:pt-3 lg:pt-4 pr-4 sm:pr-6 lg:pr-8 pb-2 sm:pb-3 lg:pb-4 pl-4 sm:pl-6 lg:pl-8 text-lg font-normal overflow-x-auto scrollbar-none"
			>
				<a href="/" class="no-underline text-black dark:text-white">Home</a>
				<a href="/devices" class="no-underline text-black dark:text-white">Devices</a>
				<a href="/uplinks" class="no-underline text-black dark:text-white">Uplinks</a>
				<a href="/downlinks" class="no-underline text-black dark:text-white">Downlinks</a>
			</nav>
		</header>
		<main class="m-4 sm:m-6 lg:m-8">
			<div
				id="tabs"
				class="flex gap-2 sm:gap-3 lg:gap-4 m-0 mb-2 sm:mb-3 lg:mb-4 pt-2 sm:pt-3 lg:pt-4 pb-2 sm:pb-3 lg:pb-4 text-base font-normal border-0 border-b-1 border-solid border-b-neutral-400 dark:border-b-neutral-600 overflow-x-auto scrollbar-none"
			>
				<a class="no-underline text-black dark:text-white">Details</a>
				<a class="no-underline text-black dark:text-white">Readings</a>
				<a class="no-underline text-black dark:text-white">Metrics</a>
				<a class="no-underline text-blue-600 dark:text-blue-400">Signals</a>
			</div>
			<div class="flex flex-col gap-2 sm:gap-3 lg:gap-4">
				<div id="ranges" class="flex gap-2 sm:gap-3 md:gap-4 overflow-x-auto scrollbar-none text-nowrap">
					<button
						value="1209600"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(1209600); setRange(1209600); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">14d</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">14 days</p>
					</button>
					<button
						value="604800"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(604800); setRange(604800); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">7d</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">7 days</p>
					</button>
					<button
						value="345600"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(345600); setRange(345600); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">4d</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">4 days</p>
					</button>
					<button
						value="172800"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(172800); setRange(172800); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">2d</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">2 days</p>
					</button>
					<button
						value="86400"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(86400); setRange(86400); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">24h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">24 hours</p>
					</button>
					<button
						value="43200"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(43200); setRange(43200); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">12h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">12 hours</p>
					</button>
					<button
						value="21600"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(21600); setRange(21600); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">6h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">6 hours</p>
					</button>
					<button
						value="10800"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(10800); setRange(10800); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">3h</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">3 hours</p>
					</button>
					<button
						value="3600"
						class="p-1 md:p-1.5 lg:p-2 border-none background-neutral-100 dark:background-neutral-900 cursor-pointer"
						onclick="highlightRange(3600); setRange(3600); loadSignals()"
					>
						<p class="sm:hidden m-0 text-base font-normal text-black dark:text-white">60m</p>
						<p class="hidden sm:block m-0 text-base font-normal text-black dark:text-white">60 minutes</p>
					</button>
				</div>
				<div class="p-2 sm:p-3 lg:p-4 background-neutral-100 dark:background-neutral-900">
					<div class="flex justify-between gap-2 mb-1 sm:mb-2">
						<h2 class="m-0 text-base font-normal">Rssi</h2>
						<p id="rssi-range" class="m-0 w-28 h-4.5 background-neutral-200 dark:background-neutral-800"><span></span><span></span><span></span></p>
					</div>
					<div style="grid-template-columns: auto 1fr; grid-template-rows: auto auto" class="grid gap-1 sm:gap-2">
						<div id="rssi-scale" class="flex flex-col text-xs text-end">
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
						<div class="relative flex flex-col">
							<svg id="rssi-graph" class="absolute w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
								<path
									class="stroke-neutral-200 dark:stroke-neutral-800"
									fill="none"
									stroke-width="2"
									d="M 0 52 L 1 41 L 2 36 L 3 35 L 4 32 L 5 32 L 6 38 L 7 34 L 8 50 L 9 37 L 10 46 L 11 30 L 12 47 L 13 34 L 14 31 L 15 33 L 16 47 L 17 30 L 18 47 L 19 41 L 20 57 L 21 65 L 22 61 L 23 71 L 24 70 L 25 52 L 26 44 L 27 53 L 28 56 L 29 55 L 30 46 L 31 41 L 32 44 L 33 32 L 34 41 L 35 47 L 36 35 L 37 39 L 38 43 L 39 41 L 40 35 L 41 46 L 42 62 L 43 51 L 44 57 L 45 44 L 46 61 L 47 61 L 48 66 L 49 84 L 50 78 L 51 64 L 52 48 L 53 44 L 54 44 L 55 31 L 56 33 L 57 39 L 58 45 L 59 44 L 60 55 L 61 60 L 62 52 L 63 57 L 64 61 L 65 56 L 66 55 L 67 41 L 68 33 L 69 49 L 70 46 L 71 38 L 72 49 L 73 55 L 74 54 L 75 71 L 76 67 L 77 69 L 78 54 L 79 50 L 80 34 L 81 36 L 82 43 L 83 42 L 84 32 L 85 33 L 86 51 L 87 53 L 88 48 L 89 61 L 90 68 L 91 79 L 92 70 L 93 68 L 94 58 L 95 55 L 96 72 L 97 88 L 98 86 L 99 95 L 100 88"
								/>
								<path class="stroke-red-400/80 dark:stroke-red-600/80" fill="none" stroke-width="2" />
								<path class="stroke-orange-400/80 dark:stroke-orange-600/80" fill="none" stroke-width="2" />
								<path class="stroke-amber-400/80 dark:stroke-amber-600/80" fill="none" stroke-width="2" />
								<path class="stroke-yellow-400/80 dark:stroke-yellow-600/80" fill="none" stroke-width="2" />
								<path class="stroke-lime-400/80 dark:stroke-lime-600/80" fill="none" stroke-width="2" />
								<path class="stroke-green-400/80 dark:stroke-green-600/80" fill="none" stroke-width="2" />
							</svg>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
						</div>
						<div></div>
						<div id="rssi-label" class="w-full flex justify-around text-xs">
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
					</div>
				</div>
				<div class="p-2 sm:p-3 lg:p-4 background-neutral-100 dark:background-neutral-900">
					<div class="flex justify-between gap-2 mb-1 sm:mb-2">
						<h2 class="m-0 text-base font-normal">Snr</h2>
						<p id="snr-range" class="m-0 w-28 h-4.5 background-neutral-200 dark:background-neutral-800"><span></span><span></span><span></span></p>
					</div>
					<div style="grid-template-columns: auto 1fr; grid-template-rows: auto auto" class="grid gap-1 sm:gap-2">
						<div id="snr-scale" class="flex flex-col text-xs text-end">
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="min-w-7 h-4 mt-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
						<div class="relative flex flex-col">
							<svg id="snr-graph" class="absolute w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
								<path
									class="stroke-neutral-200 dark:stroke-neutral-800"
									fill="none"
									stroke-width="2"
									d="M 0 48 L 1 62 L 2 57 L 3 60 L 4 50 L 5 46 L 6 63 L 7 70 L 8 54 L 9 51 L 10 64 L 11 68 L 12 72 L 13 67 L 14 63 L 15 60 L 16 44 L 17 40 L 18 55 L 19 50 L 20 46 L 21 62 L 22 66 L 23 71 L 24 58 L 25 48 L 26 50 L 27 34 L 28 44 L 29 53 L 30 69 L 31 58 L 32 51 L 33 56 L 34 48 L 35 67 L 36 65 L 37 80 L 38 75 L 39 71 L 40 64 L 41 68 L 42 52 L 43 60 L 44 74 L 45 77 L 46 66 L 47 63 L 48 57 L 49 54 L 50 59 L 51 45 L 52 52 L 53 36 L 54 50 L 55 64 L 56 68 L 57 74 L 58 58 L 59 61 L 60 47 L 61 44 L 62 52 L 63 65 L 64 60 L 65 62 L 66 55 L 67 50 L 68 66 L 69 70 L 70 84 L 71 81 L 72 65 L 73 49 L 74 52 L 75 64 L 76 68 L 77 53 L 78 50 L 79 66 L 80 71 L 81 55 L 82 51 L 83 57 L 84 40 L 85 49 L 86 66 L 87 58 L 88 78 L 89 85 L 90 73 L 91 75 L 92 66 L 93 63 L 94 72 L 95 80 L 96 88 L 97 74 L 98 64 L 99 48 L 100 54"
								/>
								<path class="stroke-red-400/80 dark:stroke-red-600/80" fill="none" stroke-width="2" />
								<path class="stroke-orange-400/80 dark:stroke-orange-600/80" fill="none" stroke-width="2" />
								<path class="stroke-amber-400/80 dark:stroke-amber-600/80" fill="none" stroke-width="2" />
								<path class="stroke-yellow-400/80 dark:stroke-yellow-600/80" fill="none" stroke-width="2" />
								<path class="stroke-lime-400/80 dark:stroke-lime-600/80" fill="none" stroke-width="2" />
								<path class="stroke-green-400/80 dark:stroke-green-600/80" fill="none" stroke-width="2" />
							</svg>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
							<span class="box-border h-8 border-0 border-b-1 border-solid border-neutral-300 dark:border-neutral-600"></span>
						</div>
						<div></div>
						<div id="snr-label" class="w-full flex justify-around text-xs">
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden sm:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
							<label class="hidden lg:inline w-8 h-4 text-neutral-600 dark:text-neutral-400 background-neutral-200 dark:background-neutral-800"></label>
						</div>
					</div>
				</div>
			</div>
		</main>
	</body>
	<script>
		import './src/app/scripts/breakpoint.js';
		import './src/app/scripts/timespan.js';
		import './src/app/scripts/array.js';
		import './src/app/scripts/state.js';
		import './src/app/scripts/math.js';
		import './src/app/scripts/fade.js';
		import './src/app/scripts/color-signal.js';
		import './src/app/scripts/binary.js';
		import './src/app/scripts/fetcher.js';
		import './src/app/scripts/fetching.js';
		const tabs = document.getElementById('tabs');
		tabs.children[0].href = `${window.location.pathname.substring(0, 40)}`;
		tabs.children[1].href = `${window.location.pathname.substring(0, 40)}/readings`;
		tabs.children[2].href = `${window.location.pathname.substring(0, 40)}/metrics`;
		tabs.children[3].href = `${window.location.pathname.substring(0, 40)}/signals`;
		const ranges = document.getElementById('ranges');
		const signals = { retries: 0, reload: null, timeout: null, controller: null, data: null, width: breakpoint() };
		const rssi = {
			range: document.getElementById('rssi-range'),
			scale: document.getElementById('rssi-scale'),
			graph: document.getElementById('rssi-graph'),
			label: document.getElementById('rssi-label'),
		};
		const snr = {
			range: document.getElementById('snr-range'),
			scale: document.getElementById('snr-scale'),
			graph: document.getElementById('snr-graph'),
			label: document.getElementById('snr-label'),
		};
		const rssiSkeleton = [
			52, 41, 36, 35, 32, 32, 38, 34, 50, 37, 46, 30, 47, 34, 31, 33, 47, 30, 47, 41, 57, 65, 61, 71, 70, 52, 44, 53, 56, 55, 46, 41, 44, 32, 41, 47, 35, 39,
			43, 41, 35, 46, 62, 51, 57, 44, 61, 61, 66, 84, 78, 64, 48, 44, 44, 31, 33, 39, 45, 44, 55, 60, 52, 57, 61, 56, 55, 41, 33, 49, 46, 38, 49, 55, 54, 71,
			67, 69, 54, 50, 34, 36, 43, 42, 32, 33, 51, 53, 48, 61, 68, 79, 70, 68, 58, 55, 72, 88, 86, 95, 88,
		];
		const snrSkeleton = [
			48, 62, 57, 60, 50, 46, 63, 70, 54, 51, 64, 68, 72, 67, 63, 60, 44, 40, 55, 50, 46, 62, 66, 71, 58, 48, 50, 34, 44, 53, 69, 58, 51, 56, 48, 67, 65, 80,
			75, 71, 64, 68, 52, 60, 74, 77, 66, 63, 57, 54, 59, 45, 52, 36, 50, 64, 68, 74, 58, 61, 47, 44, 52, 65, 60, 62, 55, 50, 66, 70, 84, 81, 65, 49, 52, 64,
			68, 53, 50, 66, 71, 55, 51, 57, 40, 49, 66, 58, 78, 85, 73, 75, 66, 63, 72, 80, 88, 74, 64, 48, 54,
		];
		window.addEventListener('resize', () => {
			const width = breakpoint();
			if (width !== signals.width) {
				signals.width = width;
				const summary = calculateSignals(signals.data, signals.width);
				window.requestAnimationFrame(() => paintRssi(rssi, signals.width, summary.rssi, summary.receivedAt));
				window.requestAnimationFrame(() => paintSnr(snr, signals.width, summary.snr, summary.receivedAt));
			}
		});
		const getRange = () => {
			const range = new URLSearchParams(window.location.search).get('range');
			return +(range ?? 86400);
		};
		const setRange = (range) => {
			const params = new URLSearchParams(window.location.search);
			params.set('range', range);
			window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
		};
		const highlightRange = (range) => {
			array(ranges.children.length).forEach((ind) => {
				if (+ranges.children[ind].getAttribute('value') === range) {
					array(ranges.children[ind].children.length).forEach((i) => {
						ranges.children[ind].children[i].classList.add('text-blue-600', 'dark:text-blue-400');
						ranges.children[ind].children[i].classList.remove('text-black', 'dark:text-white');
					});
				} else {
					array(ranges.children[ind].children.length).forEach((i) => {
						ranges.children[ind].children[i].classList.remove('text-blue-600', 'dark:text-blue-400');
						ranges.children[ind].children[i].classList.add('text-black', 'dark:text-white');
					});
				}
			});
		};
		highlightRange(getRange());
		const indexRssi = (value) => {
			switch (true) {
				case value < -125:
					return 1;
				case value >= -125 && value < -115:
					return 2;
				case value >= -115 && value < -100:
					return 3;
				case value >= -100 && value < -80:
					return 4;
				case value >= -80 && value < -60:
					return 5;
				case value >= -60:
					return 6;
			}
		};
		const loadingRssi = (element, width) => {
			array(element.label.children.length).forEach((ind) => {
				loading(element.label.children[ind], ['w-8'], [], '');
			});
			loading(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				loading(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				loading(element.scale.children[ind], [], [], '');
			});
			element.graph.setAttribute('viewBox', `0 0 ${width} 100`);
			array(element.graph.children.length).forEach((ind) => {
				if (ind === 0) {
					element.graph.children[ind].classList.add('stroke-neutral-200', 'dark:stroke-neutral-800');
					element.graph.children[ind].classList.remove('stroke-red-200', 'dark:stroke-red-800');
					const factor = width / (rssiSkeleton.length - 1);
					const skeleton = rssiSkeleton.map((value, ind) => `${ind === 0 ? 'M' : 'L'} ${(ind * factor).toFixed(2)} ${value}`);
					element.graph.children[ind].setAttribute('d', skeleton.join(' '));
				} else {
					element.graph.children[ind].removeAttribute('d');
				}
			});
		};
		const paintRssi = (element, width, rssi, receivedAt) => {
			const interval = (Number(receivedAt.end) - Number(receivedAt.start)) / (element.label.children.length - 1);
			if (receivedAt.start !== null && receivedAt.end !== null) {
				array(element.label.children.length).forEach((ind) => {
					const label = timespan(Number(receivedAt.start) + ind * interval, getRange());
					paint(element.label.children[element.label.children.length - ind - 1], [], ['w-8'], label);
				});
			}
			if (rssi.min.abs !== null && rssi.max.abs !== null) {
				paint(element.range, [], ['w-28', 'h-4.5']);
				paint(element.range.children[0], [], [], rssi.min.abs.toFixed(0));
				fade(element.range.children[0]);
				colorRssi(element.range.children[0], rssi.min.abs);
				paint(element.range.children[1], [], [], ' - ');
				paint(element.range.children[2], [], [], rssi.max.abs.toFixed(0));
				fade(element.range.children[2]);
				colorRssi(element.range.children[2], rssi.max.abs);
			}
			if (rssi.min.floor !== null && rssi.max.ceil !== null) {
				const scaleLength = element.scale.children.length;
				const interval = (rssi.max.ceil - rssi.min.floor) / scaleLength;
				array(scaleLength).forEach((ind) => {
					paint(element.scale.children[scaleLength - 1 - ind], [], [], (rssi.min.floor + ind * interval).toFixed(0));
				});
			}
			let memo = null;
			const distance = width / rssi.points.length;
			rssi.points.forEach((point, ind) => {
				const index = indexRssi(point.v);
				const last = ind === 0 ? point : rssi.points[ind - 1];
				let type = rssi.paths[index].length === 0 ? 'M' : 'L';
				if (last.x - point.x > distance * 8) {
					type = 'M';
				} else if (memo !== null && memo !== index) {
					type = 'M';
					rssi.paths[memo].push(`L ${point.x.toFixed(2)} ${point.y.toFixed(2)}`);
				}
				memo = index;
				rssi.paths[index].push(`${type} ${point.x.toFixed(2)} ${point.y.toFixed(2)}`);
			});
			element.graph.setAttribute('viewBox', `0 0 ${width} 100`);
			const factor = width / (rssiSkeleton.length - 1);
			const skeleton = rssiSkeleton.map((value, ind) => `${ind === 0 ? 'M' : 'L'} ${(ind * factor).toFixed(2)} ${value}`);
			element.graph.children[0].setAttribute('d', skeleton.join(' '));
			if (receivedAt.start !== null && receivedAt.end !== null) {
				rssi.paths.forEach((path, ind) => {
					if (path.length !== 0) {
						element.graph.children[ind].setAttribute('d', path.join(' '));
					} else {
						element.graph.children[ind].removeAttribute('d');
					}
				});
			}
		};
		const errorRssi = (element, width) => {
			array(element.label.children.length).forEach((ind) => {
				error(element.label.children[ind], ['w-8'], [], '');
			});
			error(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				error(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				error(element.scale.children[ind], [], [], '');
			});
			element.graph.setAttribute('viewBox', `0 0 ${width} 100`);
			array(element.graph.children.length).forEach((ind) => {
				if (ind === 0) {
					element.graph.children[ind].classList.add('stroke-red-200', 'dark:stroke-red-800');
					element.graph.children[ind].classList.remove('stroke-neutral-200', 'dark:stroke-neutral-800');
					const factor = width / (rssiSkeleton.length - 1);
					const skeleton = rssiSkeleton.map((value, ind) => `${ind === 0 ? 'M' : 'L'} ${(ind * factor).toFixed(2)} ${value}`);
					element.graph.children[ind].setAttribute('d', skeleton.join(' '));
				} else {
					element.graph.children[ind].removeAttribute('d');
				}
			});
		};
		const indexSnr = (value) => {
			switch (true) {
				case value < -15:
					return 1;
				case value >= -15 && value < -10:
					return 2;
				case value >= -10 && value < -5:
					return 3;
				case value >= -5 && value < 0:
					return 4;
				case value >= 0 && value < 5:
					return 5;
				case value >= 5:
					return 6;
			}
		};
		const loadingSnr = (element, width) => {
			array(element.label.children.length).forEach((ind) => {
				loading(element.label.children[ind], ['w-8'], [], '');
			});
			loading(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				loading(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				loading(element.scale.children[ind], [], [], '');
			});
			element.graph.setAttribute('viewBox', `0 0 ${width} 100`);
			array(element.graph.children.length).forEach((ind) => {
				if (ind === 0) {
					element.graph.children[ind].classList.add('stroke-neutral-200', 'dark:stroke-neutral-800');
					element.graph.children[ind].classList.remove('stroke-red-200', 'dark:stroke-red-800');
					const factor = width / (snrSkeleton.length - 1);
					const skeleton = snrSkeleton.map((value, ind) => `${ind === 0 ? 'M' : 'L'} ${(ind * factor).toFixed(2)} ${value}`);
					element.graph.children[ind].setAttribute('d', skeleton.join(' '));
				} else {
					element.graph.children[ind].removeAttribute('d');
				}
			});
		};
		const paintSnr = (element, width, snr, receivedAt) => {
			const interval = (Number(receivedAt.end) - Number(receivedAt.start)) / (element.label.children.length - 1);
			if (receivedAt.start !== null && receivedAt.end !== null) {
				array(element.label.children.length).forEach((ind) => {
					const label = timespan(Number(receivedAt.start) + ind * interval, getRange());
					paint(element.label.children[element.label.children.length - ind - 1], [], ['w-8'], label);
				});
			}
			if (snr.min.abs !== null && snr.max.abs !== null) {
				paint(element.range, [], ['w-28', 'h-4.5']);
				paint(element.range.children[0], [], [], snr.min.abs.toFixed(2));
				fade(element.range.children[0]);
				colorSnr(element.range.children[0], snr.min.abs);
				paint(element.range.children[1], [], [], ' - ');
				paint(element.range.children[2], [], [], snr.max.abs.toFixed(2));
				fade(element.range.children[2]);
				colorSnr(element.range.children[2], snr.max.abs);
			}
			if (snr.min.floor !== null && snr.max.ceil !== null) {
				const scaleLength = element.scale.children.length;
				const interval = (snr.max.ceil - snr.min.floor) / scaleLength;
				array(scaleLength).forEach((ind) => {
					paint(element.scale.children[scaleLength - 1 - ind], [], [], (snr.min.floor + ind * interval).toFixed(1));
				});
			}
			let memo = null;
			const distance = width / snr.points.length;
			snr.points.forEach((point, ind) => {
				const index = indexSnr(point.v);
				const last = ind === 0 ? point : snr.points[ind - 1];
				let type = snr.paths[index].length === 0 ? 'M' : 'L';
				if (last.x - point.x > distance * 8) {
					type = 'M';
				} else if (memo !== null && memo !== index) {
					type = 'M';
					snr.paths[memo].push(`L ${point.x.toFixed(2)} ${point.y.toFixed(2)}`);
				}
				memo = index;
				snr.paths[index].push(`${type} ${point.x.toFixed(2)} ${point.y.toFixed(2)}`);
			});
			element.graph.setAttribute('viewBox', `0 0 ${width} 100`);
			const factor = width / (snrSkeleton.length - 1);
			const skeleton = snrSkeleton.map((value, ind) => `${ind === 0 ? 'M' : 'L'} ${(ind * factor).toFixed(2)} ${value}`);
			element.graph.children[0].setAttribute('d', skeleton.join(' '));
			if (receivedAt.start !== null && receivedAt.end !== null) {
				snr.paths.forEach((path, ind) => {
					if (path.length !== 0) {
						element.graph.children[ind].setAttribute('d', path.join(' '));
					} else {
						element.graph.children[ind].removeAttribute('d');
					}
				});
			}
		};
		const errorSnr = (element, width) => {
			array(element.label.children.length).forEach((ind) => {
				error(element.label.children[ind], ['w-8'], [], '');
			});
			error(element.range, ['w-28', 'h-4.5'], []);
			array(element.range.children.length).forEach((ind) => {
				loading(element.range.children[ind], [], [], '');
			});
			array(element.scale.children.length).forEach((ind) => {
				error(element.scale.children[ind], [], [], '');
			});
			element.graph.setAttribute('viewBox', `0 0 ${width} 100`);
			array(element.graph.children.length).forEach((ind) => {
				if (ind === 0) {
					element.graph.children[ind].classList.add('stroke-red-200', 'dark:stroke-red-800');
					element.graph.children[ind].classList.remove('stroke-neutral-200', 'dark:stroke-neutral-800');
					const factor = width / (snrSkeleton.length - 1);
					const skeleton = snrSkeleton.map((value, ind) => `${ind === 0 ? 'M' : 'L'} ${(ind * factor).toFixed(2)} ${value}`);
					element.graph.children[ind].setAttribute('d', skeleton.join(' '));
				} else {
					element.graph.children[ind].removeAttribute('d');
				}
			});
		};
		const summarizeSignals = (signals, data, type) => {
			const target = signals[type];
			data.forEach((signal) => {
				if (target.min.abs === null || signal[type] < target.min.abs) {
					target.min.abs = signal[type];
				}
				if (target.max.abs === null || signal[type] > target.max.abs) {
					target.max.abs = signal[type];
				}
			});
		};
		const normalizeSignals = (signals, type) => {
			const target = signals[type];
			if (target.min.abs !== null && target.max.abs !== null) {
				target.min.floor = floor(target.min.abs, target.max.abs - target.min.abs);
				target.max.ceil = ceil(target.max.abs, target.max.abs - target.min.abs);
			}
		};
		const coordinateSignals = (signals, data, type, width) => {
			const target = signals[type];
			const xRange = Number(signals.receivedAt.end) - Number(signals.receivedAt.start);
			const yRange = target.max.ceil - target.min.floor;
			data.forEach((signal) => {
				const xPercent = width - ((Number(signal.receivedAt) - Number(signals.receivedAt.start)) / xRange) * width;
				const yPercent = 100 - ((signal[type] - target.min.floor) / yRange) * 100;
				target.points.push({ x: xPercent, y: yPercent, v: signal[type] });
			});
		};
		const calculateSignals = (data, width) => {
			const signals = {
				rssi: {
					min: { abs: null, floor: null },
					max: { abs: null, ceil: null },
					points: [],
					paths: array(rssi.graph.children.length).map(() => []),
				},
				snr: {
					min: { abs: null, floor: null },
					max: { abs: null, ceil: null },
					points: [],
					paths: array(snr.graph.children.length).map(() => []),
				},
				receivedAt: { start: null, end: null },
			};
			if (data !== null) {
				signals.receivedAt.start = Math.floor(Date.now() / 1000);
				signals.receivedAt.end = Math.floor(Date.now() / 1000 - getRange());
				summarizeSignals(signals, data, 'rssi');
				summarizeSignals(signals, data, 'snr');
				normalizeSignals(signals, 'rssi');
				normalizeSignals(signals, 'snr');
				coordinateSignals(signals, data, 'rssi', width);
				coordinateSignals(signals, data, 'snr', width);
			}
			return signals;
		};
		const parseSignals = async (response) => {
			const buffer = await response.arrayBuffer();
			const binary = new Binary(buffer);
			const signals = [];
			while (binary.offset < buffer.byteLength) {
				const signal = { rssi: null, snr: null, receivedAt: null };
				signal.rssi = binary.int(16);
				signal.snr = binary.int(8) / 4;
				signal.receivedAt = binary.uint(64);
				signals.push(signal);
			}
			return signals;
		};
		const loadSignals = fetching(
			signals,
			(context) => {
				window.requestAnimationFrame(() => loadingRssi(rssi, context.width));
				window.requestAnimationFrame(() => loadingSnr(snr, context.width));
			},
			(context) => {
				context.reload = getRange() / 360;
				const from = Math.floor(Date.now() / 1000) - getRange();
				const to = Math.floor(Date.now() / 1000);
				const endpoint = `/api/device/${window.location.pathname.substring(8)}?from=${from}&to=${to}`;
				return fetcher('get', endpoint, null, { controller: context.controller });
			},
			async (context, response) => (context.data = await parseSignals(response)),
			(context) => {
				const summary = calculateSignals(context.data, context.width);
				window.requestAnimationFrame(() => paintRssi(rssi, context.width, summary.rssi, summary.receivedAt));
				window.requestAnimationFrame(() => paintSnr(snr, context.width, summary.snr, summary.receivedAt));
				highlightRange(getRange());
			},
			(context) => {
				window.requestAnimationFrame(() => errorRssi(rssi, context.width));
				window.requestAnimationFrame(() => errorSnr(snr, context.width));
			}
		);
	</script>
</html>
