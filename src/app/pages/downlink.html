<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="View details about the downlink" />
		<title>Warden downlink</title>
		<style></style>
	</head>
	<body
		class="font-sans min-h-dvh flex flex-col m-0 text-base leading-none text-black dark:text-white background-white dark:background-black"
		onload="loadDownlink()"
	>
		<header class="sticky top-0 w-full background-neutral-100 dark:background-neutral-900 z-4">
			<div class="flex items-center justify-between gap-4 sm:gap-6 lg:gap-8 pr-4 sm:pr-6 lg:pr-8 pl-4 sm:pl-6 lg:pl-8">
				<nav class="flex flex-row gap-2 sm:gap-3 lg:gap-4 pt-2 sm:pt-3 lg:pt-4 pb-2 sm:pb-3 lg:pb-4 text-lg font-normal overflow-x-auto scrollbar-none">
					<a href="/" class="no-underline text-black dark:text-white">Home</a>
					<a href="/devices" class="no-underline text-black dark:text-white">Devices</a>
					<a href="/zones" class="no-underline text-black dark:text-white">Zones</a>
					<a href="/uplinks" class="no-underline text-black dark:text-white">Uplinks</a>
					<a href="/downlinks" class="no-underline text-black dark:text-white">Downlinks</a>
					<a href="/users" class="no-underline text-black dark:text-white">Users</a>
				</nav>
				<a href="/profile" class="flex text-black dark:text-white">
					<icon-user ref="./src/app/components/icon-user.html" class="w-5 lg:w-6 h-5 lg:h-6" />
				</a>
			</div>
		</header>
		<main class="flex flex-col grow m-4 sm:m-6 lg:m-8">
			<div class="overflow-x-auto scrollbar-none">
				<table class="w-full text-nowrap border-collapse">
					<tbody id="downlink">
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Id</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="font-mono m-0 w-80 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Frame</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-12 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Kind</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="font-mono m-0 w-5 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Data</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="font-mono m-0 w-56 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Airtime</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-11 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Frequency</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-24 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Bandwidth</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-15 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Sf</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-4 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Cr</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-3 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Tx power</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-4 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Preamble len</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-4 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Sent at</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="m-0 w-40 h-4 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
						<tr class="border-solid border-t-0 border-r-0 border-b-1 border-l-0 border-b-neutral-300 dark:border-b-neutral-700">
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4 text-neutral-600 dark:text-neutral-400">
								<p class="m-0">Device id</p>
							</td>
							<td class="pt-2 sm:pt-3 lg:pt-4 pr-2 sm:pr-3 lg:pr-4 pb-2 sm:pb-3 lg:pb-4">
								<p class="font-mono m-0 w-80 h-4 text-blue-600 dark:text-blue-400 background-neutral-200 dark:background-neutral-800"></p>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</main>
		<footer class="w-full background-neutral-100 dark:background-neutral-900">
			<div
				class="flex flex-row justify-between gap-2 sm:gap-3 lg:gap-4 pt-2 sm:pt-3 lg:pt-4 pr-4 sm:pr-6 lg:pr-8 pb-2 sm:pb-3 lg:pb-4 pl-4 sm:pl-6 lg:pl-8 text-lg font-normal text-nowrap overflow-x-auto scrollbar-none"
			>
				<p class="m-0 text-xs font-normal text-neutral-400 dark:text-neutral-600">warden {version} {commit}</p>
				<p class="m-0 text-xs font-normal text-neutral-400 dark:text-neutral-600">written by simylein</p>
			</div>
		</footer>
	</body>
	<script>
		import './src/app/scripts/timestamp.js';
		import './src/app/scripts/state.js';
		import './src/app/scripts/fade.js';
		import './src/app/scripts/color-null.js';
		import './src/app/scripts/color-sf.js';
		import './src/app/scripts/color-cr.js';
		import './src/app/scripts/color-tx-power.js';
		import './src/app/scripts/color-preamble-len.js';
		import './src/app/scripts/binary.js';
		import './src/app/scripts/fetcher.js';
		import './src/app/scripts/fetching.js';
		const downlink = { retries: 0, reload: null, timeout: null, controller: null, data: null, element: document.getElementById('downlink') };
		const loadingDownlink = (element) => {
			loading(element.children[0].children[1].children[0], ['w-80', 'h-4'], [], '');
			loading(element.children[1].children[1].children[0], ['w-12', 'h-4'], [], '');
			loading(element.children[2].children[1].children[0], ['w-5', 'h-4'], [], '');
			fade(element.children[3].children[1].children[0]);
			loading(element.children[3].children[1].children[0], ['w-56', 'h-4'], [], '');
			loading(element.children[4].children[1].children[0], ['w-11', 'h-4'], [], '');
			loading(element.children[5].children[1].children[0], ['w-24', 'h-4'], [], '');
			loading(element.children[6].children[1].children[0], ['w-15', 'h-4'], [], '');
			fade(element.children[7].children[1].children[0]);
			loading(element.children[7].children[1].children[0], ['w-4', 'h-4'], [], '');
			fade(element.children[8].children[1].children[0]);
			loading(element.children[8].children[1].children[0], ['w-3', 'h-4'], [], '');
			fade(element.children[9].children[1].children[0]);
			loading(element.children[9].children[1].children[0], ['w-4', 'h-4'], [], '');
			fade(element.children[10].children[1].children[0]);
			loading(element.children[10].children[1].children[0], ['w-4', 'h-4'], [], '');
			loading(element.children[11].children[1].children[0], ['w-40', 'h-4'], [], '');
			loading(element.children[12].children[1].children[0], ['w-80', 'h-4'], ['cursor-pointer'], '');
		};
		const paintDownlink = (element, data) => {
			paint(element.children[0].children[1].children[0], [], ['w-80', 'h-4'], data.id);
			paint(element.children[1].children[1].children[0], [], ['w-12', 'h-4'], data.frame);
			paint(element.children[2].children[1].children[0], [], ['w-5', 'h-4'], data.kind.toString(16).padStart(2, '0'));
			if (data.data.length !== 0) {
				paint(element.children[3].children[1].children[0], [], ['w-56', 'h-4'], data.data);
				fade(element.children[3].children[1].children[0]);
			} else {
				paint(element.children[3].children[1].children[0], [], ['w-56', 'h-4'], 'null');
				colorNull(element.children[3].children[1].children[0]);
			}
			paint(element.children[4].children[1].children[0], [], ['w-11', 'h-4'], data.airtime.toFixed(3));
			paint(element.children[5].children[1].children[0], [], ['w-24', 'h-4'], data.frequency);
			paint(element.children[6].children[1].children[0], [], ['w-15', 'h-4'], data.bandwidth);
			paint(element.children[7].children[1].children[0], [], ['w-4', 'h-4'], data.sf);
			fade(element.children[7].children[1].children[0]);
			colorSf(element.children[7].children[1].children[0], data.sf);
			paint(element.children[8].children[1].children[0], [], ['w-3', 'h-4'], data.cr);
			fade(element.children[8].children[1].children[0]);
			colorCr(element.children[8].children[1].children[0], data.cr);
			paint(element.children[9].children[1].children[0], [], ['w-4', 'h-4'], data.txPower);
			fade(element.children[9].children[1].children[0]);
			colorTxPower(element.children[9].children[1].children[0], data.txPower);
			paint(element.children[10].children[1].children[0], [], ['w-4', 'h-4'], data.preambleLen);
			fade(element.children[10].children[1].children[0]);
			colorPreambleLen(element.children[10].children[1].children[0], data.preambleLen);
			paint(element.children[11].children[1].children[0], [], ['w-40', 'h-4'], timestamp(data.sentAt));
			element.children[12].children[1].children[0].classList.add('cursor-pointer');
			element.children[12].children[1].children[0].onclick = () => (window.location.href = `/device/${data.deviceId}`);
			paint(element.children[12].children[1].children[0], [], ['w-80', 'h-4'], data.deviceId);
		};
		const errorDownlink = (element) => {
			error(element.children[0].children[1].children[0], ['w-80', 'h-4'], [], '');
			error(element.children[1].children[1].children[0], ['w-12', 'h-4'], [], '');
			error(element.children[2].children[1].children[0], ['w-5', 'h-4'], [], '');
			fade(element.children[3].children[1].children[0]);
			error(element.children[3].children[1].children[0], ['w-56', 'h-4'], [], '');
			error(element.children[4].children[1].children[0], ['w-11', 'h-4'], [], '');
			error(element.children[5].children[1].children[0], ['w-24', 'h-4'], [], '');
			error(element.children[6].children[1].children[0], ['w-15', 'h-4'], [], '');
			fade(element.children[7].children[1].children[0]);
			error(element.children[7].children[1].children[0], ['w-4', 'h-4'], [], '');
			fade(element.children[8].children[1].children[0]);
			error(element.children[8].children[1].children[0], ['w-3', 'h-4'], [], '');
			fade(element.children[9].children[1].children[0]);
			error(element.children[9].children[1].children[0], ['w-4', 'h-4'], [], '');
			fade(element.children[10].children[1].children[0]);
			error(element.children[10].children[1].children[0], ['w-4', 'h-4'], [], '');
			error(element.children[11].children[1].children[0], ['w-40', 'h-4'], [], '');
			error(element.children[12].children[1].children[0], ['w-80', 'h-4'], ['cursor-pointer'], '');
		};
		const parseDownlink = async (response) => {
			const buffer = await response.arrayBuffer();
			const binary = new Binary(buffer);
			const downlink = {
				id: null,
				frame: null,
				kind: null,
				data: null,
				airtime: null,
				frequency: null,
				bandwidth: null,
				sf: null,
				cr: null,
				txPower: null,
				preambleLen: null,
				sentAt: null,
				deviceId: null,
			};
			downlink.id = binary.uuid();
			downlink.frame = binary.uint(16);
			downlink.kind = binary.byte();
			downlink.data = binary.hex(binary.uint(8));
			downlink.airtime = binary.uint(16) / (16 * 1000);
			downlink.frequency = binary.uint(32);
			downlink.bandwidth = binary.uint(32);
			downlink.sf = binary.uint(8);
			downlink.cr = binary.uint(8);
			downlink.txPower = binary.uint(8);
			downlink.preambleLen = binary.uint(8);
			downlink.sentAt = binary.uint(64);
			downlink.deviceId = binary.uuid();
			return downlink;
		};
		const loadDownlink = fetching(
			downlink,
			(context) => window.requestAnimationFrame(() => loadingDownlink(context.element)),
			(context) => fetcher('get', `/api/downlink/${window.location.pathname.substring(10)}`, null, { controller: context.controller }),
			async (context, response) => (context.data = await parseDownlink(response)),
			(context) => window.requestAnimationFrame(() => paintDownlink(context.element, context.data)),
			(context) => window.requestAnimationFrame(() => errorDownlink(context.element)),
		);
	</script>
</html>
