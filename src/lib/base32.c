#include <stdint.h>
#include <stdio.h>

static const char charset[32] = "abcdefghijklmnopqrstuvwxyz234567";

static const uint8_t lookup[256] = {
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x01, 0x02,
		0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16,
		0x17, 0x18, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
};

int base32_encode(char *buf, const size_t buf_len, const void *bin, const size_t bin_len) {
	if (buf_len != (bin_len * 8 + 4) / 5) {
		return -1;
	}

	size_t buf_ind = 0;
	size_t bin_ind = 0;
	while (bin_ind < bin_len) {
		uint8_t block[5];
		uint8_t block_len = 0;

		for (uint8_t ind = 0; ind < sizeof(block) && bin_ind < bin_len; ind++) {
			block[ind] = ((const uint8_t *)bin)[bin_ind++];
			block_len++;
		}

		uint8_t chars = (uint8_t)((block_len * 8 + 4) / 5);
		uint64_t penta = ((uint64_t)block[0] << 32) | ((uint64_t)block[1] << 24) | ((uint64_t)block[2] << 16) |
										 ((uint64_t)block[3] << 8) | (uint64_t)block[4];

		for (uint8_t ind = 0; ind < chars; ind++) {
			buf[buf_ind++] = charset[(penta >> (35 - 5 * ind)) & 0x1f];
		}
	}

	return 0;
}

int base32_decode(void *bin, const size_t bin_len, const char *buf, const size_t buf_len) {
	if (bin_len < (buf_len * 5) / 8) {
		return -1;
	}

	size_t bin_ind = 0;
	size_t buf_ind = 0;
	while (buf_ind < buf_len) {
		uint8_t block[8];
		uint8_t block_len = 0;

		for (uint8_t ind = 0; ind < sizeof(block) && buf_ind < buf_len; ind++) {
			block[ind] = lookup[(uint8_t)buf[buf_ind++]];
			if (block[ind] == 0xff) {
				return -1;
			}
			block_len++;
		}

		uint8_t bytes = (uint8_t)((block_len * 5) / 8);
		uint64_t octa = ((uint64_t)block[0] << 35) | ((uint64_t)block[1] << 30) | ((uint64_t)block[2] << 25) |
										((uint64_t)block[3] << 20) | ((uint64_t)block[4] << 15) | ((uint64_t)block[5] << 10) |
										((uint64_t)block[6] << 5) | (uint64_t)block[7];

		for (uint8_t ind = 0; ind < bytes; ind++) {
			((uint8_t *)bin)[bin_ind++] = (octa >> (32 - ind * 8)) & 0xff;
		}
	}

	return 0;
}
